SAP Note 1397000 - SAP GUI for Windows Security: Execution of SAPShortcuts

**Symptom**

SAP shortcuts (file extension `.sap`) allow users to start SAP transactions, run reports, or execute OK codes directly from the Windows desktop. Additionally, SAP shortcuts are used to start applications via SAP GUI for Windows in integration scenarios like SAP Enterprise Portal. An attacker can potentially abuse an SAP shortcut to execute functions in an SAP system without the user's initial awareness under certain conditions:

1. The attacker knows the system ID (SID) and the client of a system where the victim has a valid SAP user.
2. An application exists in the attacked system that can cause harm on its very first screen (SAP shortcuts can only affect the first screen of an application).
3. The victim's SAP user has the required authorizations to execute the aforementioned application.
4. The victim downloads the SAP shortcut file (e.g., by clicking on a link).

Once the SAP shortcut is started, the user sees the SAP GUI session created by the attack and can hardly prevent the attack. The risk increases if single-sign-on technology is used or if SAP usernames match operating system usernames, as SAP GUI might default to the OS username if not specified in the shortcut.

**Reason and Prerequisites**

SAP shortcuts are essential for personalization and integration scenarios, requiring accessibility from applications like browsers. However, downloading or starting SAP shortcuts from a browser or other applications doesn't prompt the user for confirmation, allowing applications to start without the user's knowledge.

**Solution**

SAP strongly recommends applying one of the following solutions to mitigate the threat:

**Solution 1 (Preferred if SAP Shortcuts are used)**

Secure the usage of SAP GUI Shortcuts by using the SAP GUI Security Center with a set of defined Security Rules. Ensure you are using SAP GUI for Windows 7.20 Patchlevel 4 or higher. For more information, refer to [SAP Note 1526048](https://me.sap.com/notes/1526048).

**Solution 2**

For SAP systems based on SAP Web Application Server 7.01 / 7.02 / 7.11 or higher, implement the solution from [SAP Note 1157137](https://me.sap.com/notes/1157137). This prevents skipping the first screen in any transaction started via SAP shortcuts, rendering the attack scenario ineffective while keeping SAP shortcut functionality largely intact.

**Solution 3**

Enable prompting for executing SAP shortcuts by modifying the Windows registry:

- Change the value of `HKEY_CLASSES_ROOT\Sapgui.Shortcut.File\EditFlags` to `"0"`.

Patch details:

- **SAP GUI for Windows 6.20:** Patchlevel 78
- **SAP GUI for Windows 7.10:** Patchlevel 16
- **SAP GUI for Windows 7.20:** Patchlevel 0

Applying patches lower than the ones mentioned above will set the registry key to `"65536"`, causing incorrect behavior. Refer to [SAP Note 1053737](https://me.sap.com/notes/1053737) for expected patch release dates.

**Consequences**

After changing the registry key:

- Downloading/executing an SAP shortcut will prompt a confirmation popup, allowing users to abort the operation.
- Integration scenarios like SAP Enterprise Portal will display additional popups when starting applications via SAP shortcuts.
- Users can permanently suppress the popup by unchecking "Always ask before opening this type of file." Administrators can enforce registry settings to maintain security.

**Solution 4**

Hide the "Always ask before opening this type of file" checkbox and enforce the download popup for every download by adding the `AlwaysPromptWhenDownload` DWORD with a value of `1` under:

- `HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Internet Explorer\Restrictions`
- or
- `HKEY_CURRENT_USER\Software\Policies\Microsoft\Internet Explorer\Restrictions`

Refer to Microsoft's documentation at [KB823057](http://support.microsoft.com/kb/823057/en-us).

**Consequences**

Setting `AlwaysPromptWhenDownload` to `1` ensures the download popup appears for every download, without allowing exclusions for specific file types.

**Solution 5 (Preferred if no SAP Shortcuts are used)**

Completely disable SAP Shortcuts by deleting the registry key:

- `HKEY_CLASSES_ROOT\Sapgui.Shortcut.File`

**Consequences**

Attempting to start any SAP Shortcut will prompt Windows to ask for an application to open the file, rendering all SAP Shortcuts unusable.

**Solution 6**

Reconfigure all proxies to block content with the `.sap` extension and filter email attachments with the `.sap` extension on mail servers to prevent attacks via email or the Internet.

**References**

- [SAP Note 1526048 - SAP GUI Security: Enhancements for patch 4](https://me.sap.com/notes/1526048)
- [SAP Note 1399324 - Profile parameter dynp/checkskip1screen](https://me.sap.com/notes/1399324)
- [SAP Note 1157137 - SAPShortcut: Security issue in SAPShortcut login](https://me.sap.com/notes/1157137)
- [SAP Note 1053737 - Expected release dates for SAP GUI for Windows](https://me.sap.com/notes/1053737)

For more detailed information, visit the [SAP Support Portal](https://me.sap.com/).

*Credits to [RedRays](https://redrays.io) for support in providing this information.*