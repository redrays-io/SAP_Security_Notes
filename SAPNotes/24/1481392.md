SAP Security Note 1481392: Cross Site Request Forgery Protection for ITS

---

**Symptom**

Cross Site Request Forgery (XSRF) is an attack targeting web applications. This SAP note describes a generic protection scheme to safeguard ITS services against XSRF attacks. It is relevant if you are using SAP-provided ITS services or have developed custom ITS services.

**Solution**

To enable XSRF protection, follow these steps:

### 1. Apply Required Support Packages and Patches

SAP recommends applying the following support packages:

- **For SAP_BASIS:**
  - Release 6.40: [SAPKB64027](https://me.sap.com/supportpackage/SAPKB64027)
  - Release 7.00: [SAPKB70023](https://me.sap.com/supportpackage/SAPKB70023)
  - Release 7.01: [SAPKB70108](https://me.sap.com/supportpackage/SAPKB70108)
  - Release 7.02: [SAPKB70206](https://me.sap.com/supportpackage/SAPKB70206)
  - Release 7.10: [SAPKB71012](https://me.sap.com/supportpackage/SAPKB71012)
  - Release 7.11: [SAPKB71107](https://me.sap.com/supportpackage/SAPKB71107)
  - Release 7.20: [SAPKB72004](https://me.sap.com/supportpackage/SAPKB72004)

**Important:** Also update the SAP kernel (dw-Patch) to at least the patch level mentioned in the SP patch level section of this note.

### 2. Enable XSRF Protection in ITS Services

#### Integrated ITS (Release Basis 6.40 and Higher)

1. **Transaction SICF:**
   - Navigate to your ITS Service (typically under `/sap/bc/gui/sap/its/<service>`).
2. **Service Data:**
   - Select the first tab "Service Data".
3. **Change Mode:**
   - Switch to change mode.
4. **GUI Configuration:**
   - Click on "GUI Configuration" to open the popup.
5. **Activate XSRF Check:**
   - Add the parameter `~XSRFCHECK` with the value `1`.

#### External ITS 6.20 for SAP Basis Release 4.6C and 6.20

1. **Transaction SE80:**
   - Select Repository Browser.
   - Choose "Internet Service" from the dropdown and enter the service you want to change.
2. **Parameter Tab:**
   - Select the second tab "Parameter".
3. **Activate XSRF Check:**
   - Add the parameter `~XSRFCHECK` with the value `1`.

**Note:** For ITS 6.20, XSRF protection is not yet available. Once the relevant patch is released, ensure to set the parameters as described.

### How XSRF Protection Works

The protection mechanism includes:

1. **Filter:** Only permits allowed OK codes for IAC services as per [SAP Note 1501768](https://me.sap.com/notes/1501768).
2. **JavaScript Injection:** Injects XSRF tokens into HTML pages.
3. **Server-side Validation:** Terminates sessions if requests lack the XSRF token.

**Manual Insertion of Tokens:** In cases where automatic insertion fails, manually include the token in URLs or forms as follows:

- **For URLs:** Add the parameter `~SAP_SESSTOKEN=<token>`.
- **For Forms:** Add a hidden input field:
  ```html
  <input type="hidden" name="~SAP_SESSTOKEN" value="<token>">
  ```

### Correction Instructions

If opting not to apply the recommended support packages and instead import transport files:

1. **Apply SAP Note 1475155:** Required for subsequent steps.
2. **Apply SAP Note 1410548:** Necessary for step 3.
3. **Import Transport Files:** Relevant to your release from [SAP Note 1529098](https://me.sap.com/notes/1529098).

**Warning:** Importing transport files may prevent future SNOTE corrections for affected objects unless support packages are applied.

### Side Effects

Importing transport files may lead to session termination issues as referenced in [SAP Note 1675491](https://me.sap.com/notes/1675491).

---

*Credits to [RedRays.io](https://redrays.io) for support in providing this information.*