3080567 - [CVE-2021-38162] HTTP Request Smuggling in SAP Web Dispatcher

### Symptom

**UPDATE 22nd March 2022:** This note has been re-released with updated ‘Support Packages & Patches’ information. Kernel 7.22 has been updated with Emergency SP Stack Kernel PL1101 information.

An unauthenticated attacker can submit a malicious crafted request over a network to a front-end server which may, over a number of attempts, result in a back-end server confusing the boundaries of malicious and legitimate messages. This can result in the back-end server executing a malicious payload which can be used to read or modify any information on the server or consume server resources, making it temporarily unavailable.

### Other Terms

- [CVE-2021-38162](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-38162)

### Reason and Prerequisites

SAP Web Dispatcher is **only vulnerable** if the patch referenced in SAP Note [3000663](https://me.sap.com/notes/3000663) **has** been applied to SAP Web Dispatcher but **has not** been applied to the SAP back-end systems behind SAP Web Dispatcher.

The affected SAP back-end systems are Application Server ABAP, Application Server Java, and SAP HANA.

The landscape is **not vulnerable** if one of the following conditions is true:

- SAP Web Dispatcher is installed in front of 3rd-party components only.
- The back-ends are running on versions that contain the patches referenced in SAP Note [3000663](https://me.sap.com/notes/3000663).
- The patch referenced in SAP Note 3000663 has **not** been applied to SAP Web Dispatcher **and not** to the back-end systems (however, the less serious vulnerability described in SAP Note 3000663 exists in this case).

### Solution

**Correction**

Update your SAP Web Dispatcher.

This correction is delivered with the kernel archive SAPWEBDISP.SAR.

The correction is contained in all patch levels that are **equal to or higher** than the patch level listed in the "Support Package Patches" section of this SAP Note for the desired kernel release.

See SAP Note [908097](https://me.sap.com/notes/908097) for details about the recommended SAP Web Dispatcher version and how to download and install the patch.

**Workaround**

Please assess the workaround applicability for your SAP landscape prior to implementation.

Note that this workaround is a temporary fix and is **not** a permanent solution, and it requires more effort than the permanent solution. SAP strongly recommends you apply the corrections outlined in the security note, which can be done in lieu of the workaround or after the workaround is implemented.

Add the following rewrite rule to your Web Dispatcher configuration:

```plaintext
if %{HEADER:transfer-encoding} !strcmp ""
if %{HEADER:content-length} !strcmp ""
RegIForbiddenUrl ^(.*) -
```

If there is an existing `icm/HTTP/mod_<x> = PREFIX=/, FILE=<...>` in your setup:

1. Add the new rule (above) to your existing rule file.
2. Restart the Web Dispatcher or reload the file using the Web Administration UI.

Otherwise:

1. Create a new file on the file system (for example, in the profile directory) and enter the rule above in that file.
2. Add a new parameter `icm/HTTP/mod_0 = PREFIX=/, FILE=<your created file>`.
3. Restart the Web Dispatcher.

See the documentation on [Modification of HTTP Requests - SAP Help Portal](https://help.sap.com/viewer/683d6a1797a34730a6e005d1e8de6f22/202009.002/en-US/9699ed682b0d4e72b52cc73f521ed904.html) for more details about request rewriting.

Please assess the workaround applicability for your SAP landscape prior to implementation. Note that this workaround is a temporary fix and is **not** a permanent solution. SAP strongly recommends you apply the corrections outlined in the security note, which can be done in lieu of the workaround or after the workaround is implemented.

### CVSS

**CVSS Score:** 8.9

**CVSS Vector:** [CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:L](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator)

- **Attack Vector (AV):** Network (N)
- **Attack Complexity (AC):** High (H)
- **Privileges Required (PR):** None (N)
- **User Interaction (UI):** None (N)
- **Scope (S):** Changed (C)
- **Confidentiality Impact (C):** High (H)
- **Integrity Impact (I):** High (H)
- **Availability Impact (A):** Low (L)

### References

This document refers to [SAP Note 3000663](https://me.sap.com/notes/3000663): [CVE-2021-33683] HTTP Request Smuggling in SAP Web Dispatcher and Internet Communication Manager

### Validity

This SAP Security Note is valid for the following Software Components:

- **KRNL64NUC:** from 7.22 to 7.22
- **KRNL64NUC:** from 7.22EXT to 7.22EXT
- **KRNL64NUC:** from 7.49 to 7.49
- **KRNL64UC:** from 7.22 to 7.22
- **KRNL64UC:** from 7.22EXT to 7.22EXT
- **KRNL64UC:** from 7.49 to 7.49
- **KRNL64UC:** from 7.53 to 7.53
- **WEBDISP:** from 7.53 to 7.53
- **WEBDISP:** from 7.77 to 7.77
- **WEBDISP:** from 7.81 to 7.81
- **KERNEL:** from 7.22 to 7.22
- **KERNEL:** from 7.49 to 7.49
- **KERNEL:** from 7.53 to 7.53
- **KERNEL:** from 7.77 to 7.77
- **KERNEL:** from 7.81 to 7.81
- **KERNEL:** from 7.83 to 7.83

---

Credits to [redrays.io](https://redrays.io) for support to provided information.