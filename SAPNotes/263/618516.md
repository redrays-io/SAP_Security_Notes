618516 - Security-related enhancement of RFCEXEC program

**Symptom**
You want to restrict access to the RFCEXEC or RFCEXEC.EXE RFC server program.

**Other Terms**
RFCEXEC, RFCEXEC.EXE

**Reason and Prerequisites**
The RFCEXEC program represents an external RFC server that can be contacted by the SAP System. Using this server, you can employ various functions of the operating system. The program is part of the RFC-SDK and serves as an example of how to implement an RFC server. However, different applications are using the program productively, which necessitates the ability to restrict access to ensure security.

**Solution**
Use the RFCSDK version 6.20 patch number 35 or later. The RFCEXEC program has been enhanced with access control in this version, which includes:

1. **Adding a Logon Handler**
   - The logon handler checks whether the remote partner of each incoming RFC call is authorized to execute the required function.
   - The decision is based on:
     - **Connection Type**: Allows you to stop calls from certain external RFC clients.
     - **Remote User and Remote Client**: Applicable for connection types 2, 3, and F.
     - **SNC Partner Name**: For SNC-secured RFC communications.

2. **Enhancing RFC_REMOTE_EXEC and RFC_REMOTE_PIPE Functions**
   - Prevents the execution of certain operating system statements by maintaining a negative list of forbidden commands.
   - Each call to RFC_REMOTE_EXEC and RFC_REMOTE_PIPE checks the import parameters against the forbidden patterns.

**Configuration**
All access control information is stored in the `rfcexec.sec` operating system file. The location of this file can be in the RFCEXEC work directory or specified using the `RFCEXEC_SEC_FILE_PATH` environment variable. Ensure that the `rfcexec.sec` file is protected against unauthorized access.

**Structure of `rfcexec.sec` File**
The file format resembles Saprouter strings with the following syntax:

```
/U/<user name>/C/<client>/T/<allowed connection types>/F/<allowed functions>/O/<not allowed OS commands>/S/<allowed partner SNC name>/
```

- Use `*` as a wildcard for irrelevant entries.
- Use a comma `,` to separate list items.
- If an entry is irrelevant, use `#*#` for positive lists and a blank space `' '` for negative lists.

**Examples:**

- **No Restrictions:**
  ```
  /U/*/C/*/T/*/F/*/O/ /S/*/
  ```
- **Only ABAP System Calls Allowed:**
  ```
  /U/*/C/*/T/3/F/*/O/ /S/*/
  ```
- **Only User "SMITH" from ABAP System Allowed:**
  ```
  /U/SMITH/C/*/T/3/F/*/O/ /S/*/
  ```
- **Restricting Specific Functions and OS Commands:**
  ```
  /U/*/C/*/T/*/F/RFC_REMOTE_EXEC,RFCPING/O/rm/S/*/
  ```

**Upgrade Instructions for RFCEXEC:**

1. Download `rfcexec` (or `rfcexec.exe` for Windows) and `rfcexec.sec` from the [SAP Service Marketplace](https://me.sap.com/).
2. Copy both files into the RFCEXEC work directory. If placing `rfcexec.sec` elsewhere, set the `RFCEXEC_SEC_FILE_PATH` environment variable accordingly.
3. Modify the `rfcexec.sec` file to meet your security requirements.
4. For dynamically linked RFCEXEC programs (e.g., on Windows), ensure the RFC library is updated to version 6.20 patch level 44 or higher.

**References**
- [SAP Note 1140031 - Security Note: rfcexec/startrfc Used in File Interfaces](https://me.sap.com/notes/1140031)
- [SAP Note 1105897 - GW: reginfo and secinfo with permit and deny ACL](https://me.sap.com/notes/1105897)
- [SAP Note 1069911 - GW: Changes to the ACL list of the gateway (reginfo)](https://me.sap.com/notes/1069911)

**Credits**
Thanks to [RedRays](https://redrays.io) for supporting and providing the information for this post.