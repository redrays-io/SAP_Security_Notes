3000663 - [CVE-2021-33683] HTTP Request Smuggling in SAP Web Dispatcher and Internet Communication Manager

## Symptom

**UPDATE 28th March 2023:** This note has been re-released with minor textual correction. There have not been any changes done which require customer action.

**UPDATE 23rd November 2021:** This note has been re-released with updated text. This update was necessary to mention that AS JAVA is also affected by this vulnerability along with AS ABAP.

SAP Web Dispatcher and Internet Communication Manager (ICM) process invalid HTTP headers. The ICM in both SAP Application Server ABAP and SAP Application Server Java is affected. The incorrect handling of the invalid Transfer-Encoding header in a particular manner leads to a possibility of HTTP Request Smuggling attack. An attacker could exploit this vulnerability to bypass web application firewall protection, divert sensitive data such as customer requests, session credentials, etc.

## CVE References

- [CVE-2021-33683](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-33683)
- [CVE-2019-16869](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-16869)
- [CVE-2020-7238](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7238)

## Reason and Prerequisites

The vulnerability described in this SAP Note consists of two separate issues related to invalid HTTP headers.

**Issue A** causes that SAP Web Dispatcher and ICM process invalid HTTP headers incorrectly. This affects all landscapes that fulfill the prerequisites below.

Additionally, the HTTP standard specifies that these invalid HTTP headers must not be processed and have to be rejected. SAP Web Dispatcher and ICM do not reject these headers (**Issue B**).

**Issue B** affects only landscapes that contain components affected by [CVE-2019-16869](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-16869) or [CVE-2020-7238](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-7238). This second issue is not a vulnerability in SAP Web Dispatcher and ICM but in the affected components. Applying this SAP Note mitigates the vulnerabilities in those faulty components.

### Affected Systems

**SAP Web Dispatcher, ICM, and SAP HANA Extended Application Services Classic (XS Classic)** are affected if:

1. There is a 3rd-party load balancer, web application firewall, or HTTP reverse proxy in front of SAP Web Dispatcher, application server ABAP/Java, or SAP HANA XS.
2. There is a back-end system that is neither an application server ABAP/Java nor HANA XS behind SAP Web Dispatcher.

**SAP HANA Extended Application Services Advanced (XS Advanced)** is vulnerable if prerequisite 2 applies to all XS Advanced installations.

## Solution

### SAP Web Dispatcher and ICM

- **Patch Application:** If prerequisites are fulfilled, apply the Web Dispatcher patch or kernel patch referenced in this SAP Note. Follow the details provided in the "Support Package Patches" section below.
  
- **Configuration Change:** It is recommended to set the parameter `ict/allow_space_before_colon = FALSE` in Web Dispatcher for release 7.77 and lower. Web Dispatcher 7.81 and higher are already delivered with a secure default configuration.

  - If SAP Web Dispatcher is set up in front of the ABAP, Java, or HANA system, patching the Web Dispatcher installation is sufficient.
  - If there is no Web Dispatcher in front of the ABAP or Java back-end system, set the parameter in the ABAP or Java back-end system. This is mandatory if affected by Issue B and recommended otherwise.

### SAP HANA

- **Patch Application:** Apply the HANA database revision and/or HANA XS Advanced version referenced in this SAP Note under "Support Package Patches."
  
- **Configuration Change:** It is recommended to set `ict/allow_space_before_colon = FALSE` in HANA 2.0 SPS 5 and lower. HANA 2.0 SPS 6 and higher come with a secure default configuration.
  
  - In HANA XS Classic, set the parameter in `webdispatcher.ini` under the `[profile]` section without requiring a restart.
  - In HANA XS Advanced, add the parameter to `/hana/shared/<SID>/xs/controller_data/controller/router/webdispatcher/conf/sapwebdisp.template`.

### Additional Information / Side Effects

- **Issue A:** Patching resolves Issue A without side effects.
  
- **Issue B:** Fixing Issue B involves strict HTTP request parsing, which might affect outdated HTTP implementations, potentially disrupting some working scenarios. In older releases, strict parsing is not enabled by default to maintain backward compatibility but is enabled by default in new releases (7.81 and higher / HANA 2.0 SPS 6 and higher).

- **Error Handling:** If side effects occur, an error trace referencing this SAP Note is written to `dev_icm/dev_webdisp`. Strict parsing can be reverted by setting `ict/allow_space_before_colon = TRUE`.

## Details of SAP Web Dispatcher Patch

- **Patch Delivery:** The correction is delivered with the kernel archive `SAPWEBDISP.SAR`.
  
- **Patch Levels:** Available in patch levels equal to or higher than those listed in the "Support Package Patches" section for the desired kernel release. If no entry is present, subscribe to this SAP Note to receive updates when patches become available.
  
- **Patch Installation Instructions:**
  1. Refer to [SAP Note 908097](https://me.sap.com/notes/908097) for the recommended SAP Web Dispatcher version.
  2. Follow the instructions in [SAP Note 908097](https://me.sap.com/notes/908097) for downloading and installing SAP Web Dispatcher patches.

## Details of Kernel Patch

- **Patch Archives:** Delivered with kernel archives such as `dw.sar`, `SAPEXE.SAR`, and `SAPEXEDB.SAR`.
  
- **Patch Levels:** Available in patch levels equal to or higher than those listed in the "Support Package Patches" section for the desired kernel release. Subscribe to this SAP Note for updates.
  
- **Patch Installation Instructions:**
  1. Apply the latest SP Stack Kernel if it contains the correction. Refer to [SAP Note 2083594](https://me.sap.com/notes/2083594) for current SP Stack Kernels.
  2. Apply the hotfix only if experiencing a serious error not yet corrected by the latest SP Stack Kernel.
  3. Review the regression note [SAP Note 1802333](https://me.sap.com/notes/1802333) before installing the kernel patch.
  4. Follow instructions in [SAP Note 19466](https://me.sap.com/notes/19466) for downloading and installing kernel patches.

Refer to the [Update Strategy for the Kernel of the Application Server ABAP in On Premise Landscapes](https://support.sap.com/deployment-strategies-kernel-abap.pdf) for detailed SAP recommendations.

## CVSS

- **Score:** 5.4
- **Vector:** CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N

| Metric                  | Value                  |
|-------------------------|------------------------|
| Attack Vector (AV)      | Network (N)            |
| Attack Complexity (AC)  | Low (L)                |
| Privileges Required (PR)| Low (L)                |
| User Interaction (UI)   | None (N)               |
| Scope (S)               | Unchanged (U)          |
| Confidentiality Impact (C)| Low (L)              |
| Integrity Impact (I)    | Low (L)                |
| Availability Impact (A) | None (N)               |

## Side Effects

This document is causing side effects for [SAP Note 3027971: "Error in HTTP response: Invalid header field" caused by missing name of HTTP header field](https://me.sap.com/notes/3027971).

## Useful Links

- [Download for SNOTE](https://notesdownloads.sap.com/note/0040000000994662021)
- [PDF Version](https://userapps.support.sap.com/sap/support/sfm/notes/print/0003000663?language=en-US&token=F834C9F4B35D4F35EDE81E47EE9C7976)
- [Edit Note](https://me.sap.com/notes/0003000663/Edit)
- [Show Changes](https://me.sap.com/notesLatestChanges/0003000663/E/diff)

For more details, refer to the [SAP Note 3000663](https://me.sap.com/notes/3000663).

---

*Credits to [Red Rays](https://redrays.io) for supporting the provided information.*