3131258 - [CVE-2021-44228] Remote Code Execution vulnerability associated with Apache Log4j 2 component used in SAP HANA XSA

**Symptom**

SAP HANA XS, advanced model 1.0.140 or lower uses a version of the Open Source component Apache Log4j which is vulnerable to remote code execution ([CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)).

**Reason and Prerequisites**

You are running SAP HANA Platform with XS advanced version 1.0.140 or lower installed.

**Solution**

- **Update SAP HANA XS, Advanced Model:**  
  Update to version 1.0.141 or greater. Ensure that the versions of the XS Advanced Runtime and the XS advanced components are equal to or higher than those published on the [XS advanced media](https://me.sap.com/notes/2711421). Apply all required updates using the provided media first.

- **Secure XS Advanced Runtime:**  
  Update the XS Advanced Runtime to the [latest available patch level](https://launchpad.support.sap.com/#/softwarecenter/template/products/%20_APP=00200682500000001943&_EVENT=DISPHIER&HEADER=Y&FUNCTIONBAR=N&EVENT=TREE&NE=NAVIGATE&ENR=73555000100200004274&V=MAINT&TA=ACTUAL&PAGE=SEARCH/SAP%20EXTENDED%20APP%20SERVICES%201) (at least version 1.0.141 as per [SAP Note 3130864](https://me.sap.com/notes/3130864)) or higher.

- **Identify Vulnerable Applications:**  
  Execute the following command with the `xs` command-line client as user `XSA_ADMIN` to find vulnerable applications:

  ```bash
  xs find-artifacts -n "log4j-core*"
  ```

  Ensure that all applications use at least log4j 2.16.

**Workaround**

If updating immediately isn't feasible, secure the XS advanced platform services with these steps:

1. **Remove Vulnerable Classes:**
   Log in to your SAP HANA system as the `sidadm` user and execute:

   ```bash
   cdxs
   zip -q -d ./uaaserver/tomcat/webapps/uaa-security/WEB-INF/lib/log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
   zip -q -d ./uaaserver/tomcat/webapps/uaa-security-oidc/WEB-INF/lib/log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
   ```

   Refer to [Apache Log4j Security](https://logging.apache.org/log4j/2.x/security.html) for more details.

2. **Set Environment Variable:**
   ```bash
   xs-admin-login
   xs urevg --add LOG4J_FORMAT_MSG_NO_LOOKUPS true
   ```

3. **Restart XS Advanced:**
   ```bash
   XSA restart
   ```

   **Note:** On systems with System Replication (HSR), perform step 1 on all primary and secondary systems. Steps 2-3 are only needed on the primary system.

**CVSS**

- **Score:** 10.0
- **Vector:** CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
  - **Attack Vector:** Network (N)
  - **Attack Complexity:** Low (L)
  - **Privileges Required:** None (N)
  - **User Interaction:** None (N)
  - **Scope:** Changed (C)
  - **Confidentiality Impact:** High (H)
  - **Integrity Impact:** High (H)
  - **Availability Impact:** High (H)

**References**

- [SAP Note 3130698](https://me.sap.com/notes/3130698) - Remediating log4j CVE-2021-44228 vulnerability in XS Advanced Platform and applications
- [SAP Note 3134932](https://me.sap.com/notes/3134932) - XSA Cockpit update fails with error "Selected component SAP HANA Cockpit Stack is not compatible with XSAC_XSA_COCKPIT"
- [SAP Note 3136034](https://me.sap.com/notes/3136034) - Please update SAP Hana Cockpit to fix Remote Code Execution vulnerability associated with Apache Log4j

**Credits**

Thanks to [Redrays.io](https://redrays.io) for supporting the information provided.