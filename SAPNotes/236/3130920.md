3130920 - Remote Code Execution vulnerability associated with Apache Log4j 2 component used in SAP Data Intelligence 3 (on-premise)

---

**SAP Security Note 3130920**

**Type:** SAP Security Note  
**Category:** Program error  
**Priority:** HotNews  
**Status:** Released for Customer  
**Released On:** January 18, 2022  
**Version:** 12  
**Component:** Cross-Application Components > Data Intelligence > Core Platform (CA-DI-CP)

### Description

#### Symptom

SAP Data Intelligence 3 (on-premise) uses a version of the Open Source component Apache Log4j which has vulnerabilities [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228), [CVE-2021-45046](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046), and [CVE-2021-45105](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45105).

#### Reason and Prerequisites

The internal usage of a vulnerable Log4j, as reported in the above CVEs, can be exploited to run arbitrary code as an unauthenticated user.

### Solution

- **SAP Data Intelligence 3.1:** Install patch 3.1.9.
- **SAP Data Intelligence 3.2:** Install patch 3.2.2.

### Workaround

You can mitigate the vulnerabilities with the following procedure:

1. **Obtain administrative access** to the Kubernetes cluster where SAP Data Intelligence on-premise is deployed.
2. **Modify the UAA deployment** by adding `-Dlog4j2.formatMsgNoLookups=true` to the `CATALINA_OPTS` value.

    ```sh
    kubectl edit deployment uaa
    ```

3. **Modify the diagnostics-elasticsearch statefulset** by adding `-Dlog4j2.formatMsgNoLookups=true` to the `ES_JAVA_OPTS` value.

    ```sh
    kubectl edit statefulset diagnostics-elasticsearch
    ```

4. **Check the state** of the current options:

    ```sh
    kubectl get deployment uaa -o yaml
    kubectl get statefulset diagnostics-elasticsearch -o yaml
    ```

**One-liner Scripts:**

- **UAA deployment:**

    ```sh
    kubectl -n <namespace> set env deploy/uaa CATALINA_OPTS='<existing ops> -Dlog4j2.formatMsgNoLookups=true' --containers=uaa
    ```

- **Diagnostics-elasticsearch statefulset:**

    ```sh
    kubectl -n <namespace> set env sts/diagnostics-elasticsearch ES_JAVA_OPTS='<existing ops> -Dlog4j2.formatMsgNoLookups=true' --containers=diagnostics-elasticsearch
    ```

### CVSS Details

**CVSS Score:** 10.0  
**CVSS Vector:** [CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H)

### Additional Resources

- [Download for SNOTE](https://notesdownloads.sap.com/note/0040000000054292022)
- [PDF Version](https://userapps.support.sap.com/sap/support/sfm/notes/print/0003130920?language=en-US&token=86E8F6B33282518EDC24E9CDE1D1149D)
- [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228)
- [CVE-2021-45046](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046)
- [CVE-2021-45105](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45105)

**Credits:** Thanks to [Redrays.io](https://redrays.io) for support in providing this information.