3132744 - [CVE-2021-44228] Remote Code Execution vulnerability associated with Apache Log4j 2 component used in SAP BTP Kyma

## Symptom

Log4J is a widely used Java Open Source component for logging and tracing of application events. Recently, a severe security bug was discovered that allows attackers to exploit applications with low effort, causing severe security impact.

## Other Terms

- **Java**
- **Log4J**
- [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
- **JNDI**
- **Vulnerability**

## Reason and Prerequisites

This Security Note is relevant for all SAP BTP Kyma customers who are running Java workloads in Kyma clusters.

To the current knowledge, Java applications using certain versions of Log4j can be vulnerable to attacks as outlined in [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228).

## Solution

### Context

Log4j is a library made by the Apache Software Foundation and is used extensively in Java services for logging and tracing application events. A severe security bug in Log4j 2 allows remote code execution, potentially affecting millions of services globally.

### Is Kyma affected?

**Kyma Runtime is not affected** â€” We do not use Java services in custom Kyma components, nor in third-party ones. All container images used by Kyma were scanned by Open Source Security tools used in SAP, and we validated that Log4j is not used in Kyma components.

### Is my Java workload affected?

The vulnerable versions of Log4j 2 are all versions from 2.0-beta9 through 2.12.1 and 2.13.0 through 2.14.1. The first fixed version is 2.17.0.

#### Maven

For Maven-based projects, use this command to check which version of Log4j is used in the dependencies:

```bash
mvn dependency:tree -Dincludes=org.apache.logging.log4j:log4j-core
```

For each sub-project, this command resolves the matched Log4j-core dependent libraries. Look for lines containing `org.apache.logging.log4j:log4j-core:..`

Such a line tells you that your project uses Log4j in version 2.13.3 and is vulnerable:

```plaintext
org.apache.logging.log4j:log4j-core:jar:2.13.3:compile
```

#### Gradle

For Gradle-based projects, use this command to check which version of Log4j is used in the dependencies:

```bash
gradlew dependencyInsight --dependency org.apache.logging.log4j:log4j-core --configuration runtimeClasspath
```

If the command's output contains such a line, it means that your project uses Log4j in version 2.13.3 and is vulnerable:

```plaintext
org.apache.logging.log4j:log4j-core:jar:2.13.3:compile
```

### Best Practice

To ensure that your application does **not** use any vulnerable libraries in your dependencies, it is recommended to use open source security (OSS) tools like [Snyk](https://snyk.io/) and [WhiteSource](https://www.whitesourcesoftware.com). These tools can determine dependencies and check if the versions of libraries used are vulnerable.

### Mitigations

**The recommended mitigation** for this vulnerability is to update Log4j 2 to **version 2.17.0 or later**. This fix requires code changes and a service restart.

#### Code changes not possible

If your Java application that runs in a Docker container cannot be updated, Log4j 2 versions 2.10 to 2.14.1 support the environment variable `LOG4J_FORMAT_MSG_NO_LOOKUPS` that should be applied to the container's spec in the Kubernetes Pod deployment descriptor:

```yaml
spec:
  containers:
    - name: ...
      image: ...
      env:
        - name: LOG4J_FORMAT_MSG_NO_LOOKUPS
          value: "true"
```

- **If your Log4j 2 version is < 2.10 and cannot be updated**, you can remove the `JndiLookup` class from the classpath:

  ```bash
  zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
  ```

- **If none of the above mitigations are possible**, you can lower the attack vector by blocking the loading of any remote code via JNDI:

  - Ensure your application runs on a recent JDK version that suppresses remote JNDI lookups by default:
    - For SapMachine or any other OpenJDK-based JDK, the version must be higher than **11.0.1**.
    - If you are running on JDK 8, the version must be at least **8u191** or **SAP JVM 8.1.046**.
  - If using an older JDK and unable to update, set the following properties in the `JAVA_OPTS` environment variable:

    ```yaml
    spec:
      containers:
        - name: ...
          image: ...
          env:
            - name: JAVA_OPTS
              value: "-Dcom.sun.jndi.rmi.object.trustURLCodebase=false -Dcom.sun.jndi.cosnaming.object.trustURLCodebase=false"
    ```

    This will not completely mitigate the issue but will drastically reduce the attack vector.

## CVSS

- **CVSS Score:** 10.0
- **Vector:** CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
- **Details:**
  - **Attack Vector (AV):** Network (N)
  - **Attack Complexity (AC):** Low (L)
  - **Privileges Required (PR):** None (N)
  - **User Interaction (UI):** None (N)
  - **Scope (S):** Changed (C)
  - **Confidentiality Impact (C):** High (H)
  - **Integrity Impact (I):** High (H)
  - **Availability Impact (A):** High (H)

**Credits to [Redrays.io](https://redrays.io) for supporting the provided information.**