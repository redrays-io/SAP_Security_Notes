1718378 - Directory Traversal in Query Snapshot

## Symptom

BW contains a vulnerability through which a malicious user can potentially write arbitrary files on the remote server, possibly corrupting data or altering system behavior.

## Other Terms

Directory traversal, FILE_VALIDATE_NAME, FILE_GET_NAME, FILE, BW_RSDR, LISTCUBE, FILE_NOT_FOUND, LOGICAL_FILENAME_NOT_FOUND, DIR, QSI, QuerySnapShot, _write_trace, cl_rsdri_qprov_cmp_tc, RSR_QPROV_RSDRI_PERF

## Reason and Prerequisites

Query snapshot fails to correctly validate the path to which a user-submitted file is written. As a result, an attacker can potentially overwrite data in the remote system.

## Solution

Ensure that [SAP Note 1575722](https://me.sap.com/notes/1575722) is implemented in the system (including the manual pre-implementation steps).

BW fails to correctly validate the path to which a user-submitted file is written. As a result, an attacker can potentially overwrite data in the remote system.

- **Before the implementation of the corrections:** You were able to write performance traces using the SPA/GPA parameter `RSR_QPROV_RSDRI_PERF` if a query is based on `QuerySnapShotIndex`.
  
- **After you implement the corrections:** Only the following directories can be selected:
  - **UNIX:** `/tmp/<FILENAME>`
  - **WINDOWS NT:** `<P=DIR_TEMP>\<FILENAME>`

If you try to write data under UNIX to `/usr/sap/put/my_data`, the system rejects this.

The settings are defined in transaction `/NFILE`.
- **Logical File Path Definition:** `BW_RSDR`
- **Logical File Name Definition, Cross-Client:** `BW_RSDR` and implement the corrections.

### Supported Versions and Support Packages

- **SAP NetWeaver BW 7.30**
  - Import Support Package 8 for SAP NetWeaver BW 7.30 ([SAPKW73008](https://me.sap.com/supportpackage/SAPKW73008)) into your BW system. The Support Package is available when [SAP Note 1680997](https://me.sap.com/notes/1680997) "SAPBWNews NW BW 7.30 BW ABAP SP8" is released for customers.

- **SAP NetWeaver BW 7.31 (SAP NW BW 7.0 Enhancement Package 3)**
  - Import Support Package 5 for SAP NetWeaver BW 7.31 ([SAPKW73105](https://me.sap.com/supportpackage/SAPKW73105)) into your BW system. The Support Package is available when [SAP Note 1708177](https://me.sap.com/notes/1708177) "SAPBWNews NW BW 7.31/7.03 ABAP SP5" is released for customers.

- **Advance Corrections:**
  - You can use the attached corrections as an advance correction.

**Important:** You must first read [SAP Note 875986](https://me.sap.com/notes/875986), which provides information about transaction SNOTE.

To provide information in advance, the SAP Notes mentioned above may already be available before the Support Package is released. In this case, the short text of the SAP Note contains the words "Preliminary version".

## References

- [1575722 - Directory traversal in BW](https://me.sap.com/notes/1575722)
- [1497003 - Potential directory traversals in applications](https://me.sap.com/notes/1497003)
- [1479893 - BW LISTCUBE improvements](https://me.sap.com/notes/1479893)

## Validity

- **Software Component:** SAP_BW
  - **From:** 7.30
  - **To:** 7.30
- **Software Component:** SAP_BW
  - **From:** 7.31
  - **To:** 7.31

## Credit

Credits to [RedRays](https://redrays.io) for support to provided information.