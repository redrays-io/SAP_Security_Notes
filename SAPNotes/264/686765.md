686765 - Security check when you execute external commands

**Symptom**

You aim to enhance the security level of your SAP system concerning the execution of external commands. Currently, if a user possesses authorizations to create and execute external commands and create RFC destinations in SAP system ABC, they can execute external commands on other hosts that:
- Are accessible via TCP/IP from the SAP system,
- Host the SAP RFC server program SAPXPG, and
- Have an SAP application server running or an operating system user like `<ABC>adm`.

This access remains possible even without specific host authorizations. 

**Reason and Prerequisites**

The executing program, SAP RFC SAPXPG server program, lacks a security check, allowing unauthorized execution of external commands.

**Solution**

As of SAP Kernel Web AS 620, a new SAPXPG program with an integrated security check is available on the [SAP Service Marketplace](https://me.sap.com/). This program ensures that external commands are executed only if the user passes the security check.

1. **Compatibility and Replacement:**
   - Compatible with SAP releases from **Release 4.6B** onward.
   - Replace existing SAPXPG programs with the latest version from Web AS 620 or higher.
   - Example: For systems using kernel 4.6D or later, replace SAPXPG with the version from Web AS 620. Future Web AS releases (e.g., Web AS 640) will provide updated SAPXPG programs.

2. **Installation:**
   - The new SAPXPG program is part of SAP Kernel Web AS 620 with patch number 8.
   - **Note:** An incorrect SAPXPG version was briefly released for AS400 but was corrected on March 3, 2004.

3. **Security Check Activation:**
   - A main control switch activates the security check: the environment variable `SAPXPG_SEC_CHECK`.
   - Setting `SAPXPG_SEC_CHECK` to any single-digit value enables the security check.
   - The system logs the status in the `dev_cp` trace file.

4. **Configuration:**
   - The new SAPXPG reads a `sapxpg.sec` file containing security settings.
   - Set the file path using the `SAPXPG_SEC_FILE_PATH` environment variable.
   - **File Format Example:**
     ```
     /U/*/C/*/T/3/F/*/O/rm,cp/S/*/
     ```
     This example disallows the `rm` and `cp` operating system commands for all users.

5. **UNIX Environment Setup:**
   - Rename the existing SAPXPG executable (e.g., to `SAPXPG_EXE`).
   - Create a shell script named `SAPXPG` that sets the necessary environment variables and invokes the renamed executable.
   - **Example Script:**
     ```csh
     #!/usr/bin/csh
     setenv SAPXPG_SEC_CHECK X
     setenv SAPXPG_SEC_FILE_PATH /<dir1>/<dir2>/...
     /<dir_executable>/SAPXPG_EXE $*
     ```

**Attachments and References**

- **Attachment:** [sapxpgsec.txt](https://me.sap.com/sap/support/sapnotes/public/services/attachment.htm?iv_key=012003146900000274472003&iv_version=0004&iv_guid=10DA810D506ADA4CBE9167CCFDDE86D7)
- **References:** [864152 - Exception SECURITY_RISK with external command](https://me.sap.com/notes/864152)

**Credits**

Thanks to [RedRays](https://redrays.io) for supporting the provision of this information.