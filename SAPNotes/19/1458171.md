1458171 - Cross-site request forgery protection for BSP

## Overview
[SAP Note 1458171](https://me.sap.com/notes/1458171) addresses **Cross-Site Request Forgery (CSRF/XSRF)** protection for Business Server Pages (BSP) applications. CSRF is a prevalent attack targeting web applications by exploiting authenticated user sessions. This note provides a comprehensive protection scheme to safeguard BSP applications against such vulnerabilities.

## Description
The protection mechanism is based on the **secure token method**, where each request sent to the server includes a unique token that cannot be easily guessed by attackers. This token is a 128-bit random number generated on the SAP application server and is typically injected into the page via JavaScript.

### Steps to Secure BSP Services:

1. **Enable XSRF Protection:**
   - **Action:** Switch on the XSRF protection flag for the BSP service.
   - **Effect:** The BSP runtime will validate secure tokens for all pages not marked as "Start pages." Missing or invalid tokens will result in immediate session termination.

2. **Manual Token Handling:**
   - **Scenario:** When URLs are constructed and launched via JavaScript.
   - **Action:** Manually add the `SESSION_TOKEN` parameter using the `GET_TOKEN` method from the `CL_BSP_RUNTIME` class.
   - **Example:**
     ```javascript
     var token = CL_BSP_RUNTIME.GET_TOKEN();
     var url = "your_url_here&SESSION_TOKEN=" + token;
     ```

3. **Define Start Pages:**
   - **Purpose:** Identify pages that are safe and do not alter the system's state.
   - **Action:** Mark these pages as "Start pages" in the SE80 transaction or by editing the `BSPTEMPXSRFSTORE` table via SE16 if using the correction instruction.

4. **Single Page Applications:**
   - **Challenge:** Distinguishing safe from unsafe pages is not feasible.
   - **Solution:** Set the single controller page as a "Start page" and implement runtime validation using:
     - `CL_BSP_RUNTIME->VALIDATE_TOKEN`
     - `CL_BSP_RUNTIME->ABORT_DUE_TO_FALSE_TOKEN`

5. **Handling HTML Reset Buttons:**
   - **Issue:** Resetting forms clears hidden fields, including the secure token.
   - **Solution:** Add the `InitializeFormsDelayed()` JavaScript method to the `onclick` handler of reset buttons to restore token values.
     ```html
     <input type="reset" onclick="oSAPSecu.InitializeFormsDelayed();" />
     ```

## Recommendations
SAP strongly recommends **applying the relevant support packages** to enable XSRF protection seamlessly. If applying support packages isn't feasible, you can import transport files from [SAP Note 1532403](https://me.sap.com/notes/1532403). However, be aware that using transport files may limit your ability to apply future SNOTE corrections for the imported objects unless you update to the recommended support packages.

## Downloads
- [Download for SNOTE](https://notesdownloads.sap.com/note/0040000008602892017)
- [PDF Version](https://userapps.support.sap.com/sap/support/sfm/notes/print/0001458171?language=en-US&token=5BDA1474584B6744E767FF936A1FC410)

## References
This note references several other SAP Notes that provide additional context and support:
- [1666244](https://me.sap.com/notes/1666244) - cFolders: Composite SAP Note - Security
- [1540729](https://me.sap.com/notes/1540729) - ASU content for activating XSRF protection for BSP
- [1511193](https://me.sap.com/notes/1511193) - XSRF protection for the CCMS Monitoring Console
- [1510064](https://me.sap.com/notes/1510064) - Unauthorized usage of appl. functionality in PA-EC, PA-CP
- [1509014](https://me.sap.com/notes/1509014) - Unauthorized usage of application functionality in PA-ER
- [1491496](https://me.sap.com/notes/1491496) - Improved connection of logical transport objects

## Validity
Applicable to the following **SAP_BASIS** versions:
- 620 to 640
- 700 to 702
- 710 to 730

Ensure your system meets the prerequisites outlined in the note before implementation.

## Correction Instructions
Follow the detailed correction instructions provided in the note to implement the necessary changes. Manual activities are required if you choose not to apply the recommended support packages.

## CVSS
- **CVSS Score:** 0
- **CVSS Vector:** Not provided

## Are You Affected?
If you have **custom-developed BSP services**, it's imperative to follow the steps outlined in this note to protect your applications against CSRF attacks. SAP recommends assessing your BSP applications and implementing the necessary security measures as detailed above.

---
**Credits:** Information supported by [redrays.io](https://redrays.io).