SAP Security Note 2535629 - DLL preload attack possible on NwSapSetup and Installation self extracting program

**Symptom**

It is possible that the affected program loads system DLLs like `DWMAPI.dll` (located in your Syswow64 / System32 folder) from the folder the executable is in and not from the system location. The desired behavior is that system DLLs are only loaded from the system folders.

If a DLL with the same name as the system DLL is located in the same folder as the executable, this DLL is loaded and code is executed. As these DLLs are "delay loaded," this can happen not only at load time but at any time while the executable is running.

`NwSapSetup.exe` is usually run from protected locations created especially for the purpose of running installations (and should be protected by administrators). However, patches are delivered attached to our `selfx.exe` â€“ which is our mechanism for self-extracting archives. They might be executed e.g., from the download folder of a user's computer. These locations might contain DLLs with the name of the system DLLs with malicious code, which makes running self-extracting archives from that location a threat.

### CVSS Information

| Metric                       | Value                   |
|------------------------------|-------------------------|
| AV : Attack Vector           | Network (N)             |
| AC : Attack Complexity       | High (H)                |
| PR : Privileges Required     | None (N)                |
| UI : User Interaction        | Required (R)            |
| S  : Scope                   | Unchanged (U)           |
| C  : Confidentiality Impact  | Low (L)                 |
| I  : Integrity Impact        | Low (L)                 |
| A  : Availability Impact     | Low (L)                 |

SAP provides this CVSS v3 base score as an estimate of the risk posed by the issue reported in this note. This estimate does not take into account your own system configuration or operational environment. It is not intended to replace any risk assessments you are advised to conduct when deciding on the applicability or priority of this SAP security note. For more information, see the FAQ section at [https://support.sap.com/securitynotes](https://support.sap.com/securitynotes).

**Reason and Prerequisites**

**This note / vulnerability is relevant for you when making use of SAPSetup / NwSapSetup.exe**. This vulnerability is caused by system DLLs using the mechanism of delayloading to load other system DLLs. In our case, it is `dwmapi.dll` which is delayloaded by several other system DLLs. The behavior can occur on 32 and 64-bit platforms with 32 and 64-bit executables.

**Solution**

- **Upgrade:** Use the latest version of `NwSapSetup.exe` and the self-extractor tool to avoid this problem. Any version higher than 9.0.88 is hardened against these kinds of attacks.
  
- **Best Practices:** Older versions of `NwSapSetup.exe` and files based on our self-extractor tool should be executed from empty folders to mitigate the risk.

**Attributes**

- **Other Components:** Basis Components > Frontend Services (SAP Note 1322184) > SAP GUI for Windows (BC-FES-GUI)
- **Externally Reported:** Yes

**References**

- [SAP SSO Fixes for Secure Login Client 2.0 SP 06 Patch 06](https://me.sap.com/notes/2516850)
- [Fixes in SNC Client Encryption 2.0 SP00 Patch 01](https://me.sap.com/notes/2517732)

**Validity**

This security note is applicable to the following software components and versions:

- **LMSAPSETUP:** 9.0
- **NwSapSetup.exe:** Versions higher than 9.0.88
- *(Refer to the original note for a complete list of affected components and versions.)*

For more details and support packages, visit [https://me.sap.com/](https://me.sap.com/).

*Credits to [https://redrays.io](https://redrays.io) for support in providing this information.*